name: "PR Agent: Apply Suggestions"

on:
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [labeled]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to process"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read
  checks: write

jobs:
  gate:
    name: Gate and prepare
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.gate.outputs.should_run }}
      pr_number: ${{ steps.gate.outputs.pr_number }}
      head_sha: ${{ steps.gate.outputs.head_sha }}
      head_ref: ${{ steps.gate.outputs.head_ref }}
      head_repo: ${{ steps.gate.outputs.head_repo }}
      base_ref: ${{ steps.gate.outputs.base_ref }}
    steps:
      - name: Check triggering conditions
        id: gate
        uses: actions/github-script@v7
        with:
          script: |
            const isDispatch = context.eventName === 'workflow_dispatch';
            let shouldRun = false;
            let prNumber = null;
            let headSha = null;
            let headRef = null;
            let headRepo = null;
            let baseRef = null;

            if (isDispatch) {
              const prInput = core.getInput('pr_number');
              if (!prInput) {
                core.setOutput('should_run', 'false');
                core.warning('workflow_dispatch requires pr_number input');
                return;
              }
              const prNum = Number(prInput);
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNum,
              });
              if (!pr.draft && pr.head.repo.full_name === `${context.repo.owner}/${context.repo.repo}`) {
                shouldRun = true;
                prNumber = pr.number;
                headSha = pr.head.sha;
                headRef = pr.head.ref;
                headRepo = pr.head.repo.full_name;
                baseRef = pr.base.ref;
              }
            } else if (context.eventName === 'issue_comment') {
              // Only handle comments on PRs
              if (!context.payload.issue.pull_request) {
                core.setOutput('should_run', 'false');
                return;
              }

              const body = (context.payload.comment.body || '').toLowerCase();
              // Opt-in keywords
              const keywords = ['ai: apply', 'agent: apply', '/agent apply', '/ai apply'];
              const matchesKeyword = keywords.some(k => body.includes(k));

              // Require label gate if configured; default to optional
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.issue.number,
              });

              const labels = pr.labels?.map(l => (typeof l === 'string' ? l : l.name)) || [];
              const requireLabel = process.env.PR_AGENT_REQUIRE_LABEL || '';
              const labelsLC = labels.map(s => String(s || '').toLowerCase());
              const hasLabel = !requireLabel
                || labelsLC.includes(String(requireLabel).toLowerCase())
                || labelsLC.includes('agent:apply')
                || labelsLC.includes('ai: apply');

              if (matchesKeyword && hasLabel && !pr.draft && pr.head.repo.full_name === `${context.repo.owner}/${context.repo.repo}`) {
                shouldRun = true;
                prNumber = pr.number;
                headSha = pr.head.sha;
                headRef = pr.head.ref;
                headRepo = pr.head.repo.full_name;
                baseRef = pr.base.ref;
              }
            } else if (context.eventName === 'pull_request' && context.payload.action === 'labeled') {
              // Trigger via label alone
              const pr = context.payload.pull_request;
              const labelName = (context.payload.label?.name || '').toLowerCase();
              const accepted = ['agent:apply', 'ai: apply'];
              const matches = accepted.includes(labelName);
              if (matches && !pr.draft && pr.head.repo.full_name === `${context.repo.owner}/${context.repo.repo}`) {
                shouldRun = true;
                prNumber = pr.number;
                headSha = pr.head.sha;
                headRef = pr.head.ref;
                headRepo = pr.head.repo.full_name;
                baseRef = pr.base.ref;
              }
            }

            core.setOutput('should_run', shouldRun ? 'true' : 'false');
            if (shouldRun) {
              core.setOutput('pr_number', String(prNumber || ''));
              core.setOutput('head_sha', headSha || '');
              core.setOutput('head_ref', headRef || '');
              core.setOutput('head_repo', headRepo || '');
              core.setOutput('base_ref', baseRef || '');
            }

  apply:
    name: Apply suggestions and test
    needs: gate
    if: ${{ needs.gate.outputs.should_run == 'true' }}
    runs-on: ubuntu-latest
    concurrency:
      group: pr-agent-${{ needs.gate.outputs.pr_number }}
      cancel-in-progress: false
    steps:
      - name: Debounce window
        if: ${{ github.event_name == 'issue_comment' }}
        run: |
          SECS=${PR_AGENT_DEBOUNCE_SECONDS:-120}
          echo "Sleeping ${SECS}s to batch comments...";
          sleep ${SECS}

      - name: Set config defaults
        id: cfg
        uses: actions/github-script@v7
        with:
          script: |
            const maxFix = process.env.PR_AGENT_MAX_FIX_ROUNDS && String(process.env.PR_AGENT_MAX_FIX_ROUNDS).trim() !== ''
              ? String(process.env.PR_AGENT_MAX_FIX_ROUNDS).trim()
              : '1';
            core.setOutput('max_fix_rounds', maxFix);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.gate.outputs.head_ref }}
          fetch-depth: 0

      - name: Gather PR context (diff and comments)
        id: ctx
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number('${{ needs.gate.outputs.pr_number }}');
            const { data: pr } = await github.rest.pulls.get({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber });

            // Diff (unified)
            const { data: files } = await github.rest.pulls.listFiles({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber, per_page: 300 });
            const fileList = files.map(f => `- ${f.status.toUpperCase()} ${f.filename}`).join('\n');

            // Recent comments (limit 50)
            const { data: comments } = await github.rest.issues.listComments({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, per_page: 50, sort: 'created', direction: 'desc' });
            const reviewerBots = new Set(['sourcery-ai[bot]','coderabbitai[bot]','chatgpt-codex-connector[bot]','github-actions[bot]','claude','claude[bot]','copilot','github-copilot[bot]']);
            const condensed = comments.slice(0, 50).map(c => ({ author: c.user?.login || 'unknown', body: (c.body || '').slice(0, 4000) })).reverse();
            const reviewers = condensed.filter(c => reviewerBots.has(c.author));

            // Expose to next steps
            core.setOutput('pr_title', pr.title);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('file_list', fileList);
            core.setOutput('review_comments', JSON.stringify(reviewers));

      - name: Placeholder - AI code application not yet implemented
        id: codex_apply
        run: |
          echo "⚠️  PR Agent workflow is a template/placeholder."
          echo ""
          echo "The 'openai/codex-action@v1' does not exist as a real GitHub Action."
          echo ""
          echo "To implement AI-powered PR fixes, you need to:"
          echo "1. Use OpenAI API directly (curl + jq)"
          echo "2. Use GitHub Copilot Workspace API (if available)"
          echo "3. Build a custom agent using MCP or similar"
          echo "4. Use an existing action like:"
          echo "   - github/copilot-cli (if available)"
          echo "   - Custom Docker action with AI SDK"
          echo ""
          echo "Context for implementation:"
          echo "- PR #${{ needs.gate.outputs.pr_number }}"
          echo "- Base: ${{ needs.gate.outputs.base_ref }}"
          echo "- Files changed: See previous step output"
          echo ""
          echo "For now, skipping AI code changes."
          mkdir -p pr-agent-output
          echo "Placeholder run - no AI action available" > pr-agent-codex-output.md
          exit 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install dependencies (if package.json)
        if: ${{ hashFiles('package.json') != '' }}
        run: |
          npm ci || npm install

      - name: Run tests
        id: test1
        continue-on-error: true
        run: |
          set -o pipefail
          if [ -f "package.json" ]; then
            npm test 2>&1 | tee test-output.log || exit 1
          elif [ -f "tests/run-tests.js" ]; then
            node tests/run-tests.js 2>&1 | tee test-output.log || exit 1
          else
            echo "No tests found"; exit 0
          fi

      - name: Capture test logs on failure
        if: failure() && steps.test1.outcome == 'failure'
        run: |
          echo "Tests failed" > pr-agent-test-failure.txt
          if [ -f "test-output.log" ]; then
            echo "" >> pr-agent-test-failure.txt
            echo "=== Test Output (last 100 lines) ===" >> pr-agent-test-failure.txt
            tail -n 100 test-output.log >> pr-agent-test-failure.txt
          fi

      - name: Single repair pass (if tests failed)
        if: ${{ steps.test1.outcome == 'failure' && steps.cfg.outputs.max_fix_rounds != '0' }}
        id: codex_repair
        run: |
          echo "⚠️  Repair pass not implemented - AI action unavailable"
          echo ""
          if [ -f "pr-agent-test-failure.txt" ]; then
            echo "Test failures detected:"
            cat pr-agent-test-failure.txt
          fi
          echo ""
          echo "Manual fixes required."
          echo "Placeholder - no repair action available" > pr-agent-codex-repair.md
          exit 0

      - name: Re-run tests after repair
        if: steps.codex_repair.outcome == 'success'
        id: test2
        run: |
          set -o pipefail
          if [ -f "package.json" ]; then
            npm test 2>&1 | tee test-output-repair.log || exit 1
          elif [ -f "tests/run-tests.js" ]; then
            node tests/run-tests.js 2>&1 | tee test-output-repair.log || exit 1
          else
            echo "No tests found"; exit 0
          fi

      - name: Commit and push changes to PR branch
        if: ${{ success() && steps.codex_apply.outcome == 'success' }}
        run: |
          echo "⚠️  Skipping commit - AI agent not implemented"
          echo "No automated changes were made (placeholder workflow)"
          echo "Manual code changes are required"

      - name: Post summary comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number('${{ needs.gate.outputs.pr_number }}');
            const body = `## ⚠️  PR Agent - Not Implemented
            
            This workflow is a template/placeholder. The AI code agent is not yet functional.
            
            **What happened**
            - Workflow triggered successfully
            - Context gathered from PR
            - AI action step skipped (not implemented)
            
            **To enable this feature**
            1. Replace placeholder steps with real AI implementation
            2. Options: OpenAI API, GitHub Copilot API, or custom agent
            3. See [workflow run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}) for details
            
            Manual code review and changes are required for now.
            `;
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body });

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-agent-${{ needs.gate.outputs.pr_number }}
          path: |
            pr-agent-codex-output.md
            pr-agent-codex-repair.md
            pr-agent-test-failure.txt
          retention-days: 14

      - name: Create status check
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = '${{ needs.gate.outputs.head_sha }}';
            const prNumber = Number('${{ needs.gate.outputs.pr_number }}');
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            const title = 'PR Agent: Not Implemented';
            const summary = 'This workflow is a placeholder. AI code agent requires implementation before it can apply automated fixes.';
            const text = `Workflow run: ${runUrl}\n\nPR: #${prNumber}\n\nStatus: Template/Placeholder - No AI action available`;

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'PR Agent',
              head_sha: headSha,
              status: 'completed',
              conclusion: 'neutral',
              details_url: runUrl,
              output: { title, summary, text }
            });
