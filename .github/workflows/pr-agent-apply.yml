name: "PR Agent: Apply Suggestions"

on:
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to process"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read
  checks: write

jobs:
  gate:
    name: Gate and prepare
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.gate.outputs.should_run }}
      pr_number: ${{ steps.gate.outputs.pr_number }}
      head_sha: ${{ steps.gate.outputs.head_sha }}
      head_ref: ${{ steps.gate.outputs.head_ref }}
      head_repo: ${{ steps.gate.outputs.head_repo }}
      base_ref: ${{ steps.gate.outputs.base_ref }}
    steps:
      - name: Check triggering conditions
        id: gate
        uses: actions/github-script@v7
        with:
          script: |
            const isDispatch = context.eventName === 'workflow_dispatch';
            let shouldRun = false;
            let prNumber = null;
            let headSha = null;
            let headRef = null;
            let headRepo = null;
            let baseRef = null;

            if (isDispatch) {
              const prInput = core.getInput('pr_number');
              if (!prInput) {
                core.setOutput('should_run', 'false');
                core.warning('workflow_dispatch requires pr_number input');
                return;
              }
              const prNum = Number(prInput);
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNum,
              });
              if (!pr.draft && pr.head.repo.full_name === `${context.repo.owner}/${context.repo.repo}`) {
                shouldRun = true;
                prNumber = pr.number;
                headSha = pr.head.sha;
                headRef = pr.head.ref;
                headRepo = pr.head.repo.full_name;
                baseRef = pr.base.ref;
              }
            } else if (context.eventName === 'issue_comment') {
              // Only handle comments on PRs
              if (!context.payload.issue.pull_request) {
                core.setOutput('should_run', 'false');
                return;
              }

              const body = (context.payload.comment.body || '').toLowerCase();
              // Opt-in keywords
              const keywords = ['/review', '/improve', 'ai: apply', 'agent: apply', '/agent apply', '/ai apply'];
              const matchesKeyword = keywords.some(k => body.includes(k));

              // Require label gate if configured; default to optional
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.issue.number,
              });

              const labels = pr.labels?.map(l => (typeof l === 'string' ? l : l.name)) || [];
              const requireLabel = process.env.PR_AGENT_REQUIRE_LABEL || '';
              const labelsLC = labels.map(s => String(s || '').toLowerCase());
              const hasLabel = !requireLabel
                || labelsLC.includes(String(requireLabel).toLowerCase())
                || labelsLC.includes('agent:apply')
                || labelsLC.includes('ai: apply');

              if (matchesKeyword && hasLabel && !pr.draft && pr.head.repo.full_name === `${context.repo.owner}/${context.repo.repo}`) {
                shouldRun = true;
                prNumber = pr.number;
                headSha = pr.head.sha;
                headRef = pr.head.ref;
                headRepo = pr.head.repo.full_name;
                baseRef = pr.base.ref;
              }
            } else if (context.eventName === 'pull_request' && context.payload.action === 'labeled') {
              // Trigger via label alone
              const pr = context.payload.pull_request;
              const labelName = (context.payload.label?.name || '').toLowerCase();
              const accepted = ['agent:apply', 'ai: apply'];
              const matches = accepted.includes(labelName);
              if (matches && !pr.draft && pr.head.repo.full_name === `${context.repo.owner}/${context.repo.repo}`) {
                shouldRun = true;
                prNumber = pr.number;
                headSha = pr.head.sha;
                headRef = pr.head.ref;
                headRepo = pr.head.repo.full_name;
                baseRef = pr.base.ref;
              }
            }

            core.setOutput('should_run', shouldRun ? 'true' : 'false');
            if (shouldRun) {
              core.setOutput('pr_number', String(prNumber || ''));
              core.setOutput('head_sha', headSha || '');
              core.setOutput('head_ref', headRef || '');
              core.setOutput('head_repo', headRepo || '');
              core.setOutput('base_ref', baseRef || '');
            }

      - name: Debounce window
        if: ${{ steps.gate.outputs.should_run == 'true' && github.event_name == 'issue_comment' }}
        run: |
          SECS=${PR_AGENT_DEBOUNCE_SECONDS:-120}
          echo "Sleeping ${SECS}s to batch comments...";
          sleep ${SECS}

  apply:
    name: Apply suggestions and test
    needs: gate
    if: ${{ needs.gate.outputs.should_run == 'true' }}
    runs-on: ubuntu-latest
    concurrency:
      group: pr-agent-${{ needs.gate.outputs.pr_number }}
      cancel-in-progress: false
    steps:
      - name: Set config defaults
        id: cfg
        uses: actions/github-script@v7
        with:
          script: |
            const maxFix = process.env.PR_AGENT_MAX_FIX_ROUNDS && String(process.env.PR_AGENT_MAX_FIX_ROUNDS).trim() !== ''
              ? String(process.env.PR_AGENT_MAX_FIX_ROUNDS).trim()
              : '1';
            core.setOutput('max_fix_rounds', maxFix);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.gate.outputs.head_ref }}
          fetch-depth: 0

      - name: Gather PR context (diff and comments)
        id: ctx
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number('${{ needs.gate.outputs.pr_number }}');
            const { data: pr } = await github.rest.pulls.get({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber });

            // Diff (unified)
            const { data: files } = await github.rest.pulls.listFiles({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber, per_page: 300 });
            const fileList = files.map(f => `- ${f.status.toUpperCase()} ${f.filename}`).join('\n');

            // Recent comments (limit 50)
            const { data: comments } = await github.rest.issues.listComments({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, per_page: 50, sort: 'created', direction: 'desc' });
            const reviewerBots = new Set(['sourcery-ai[bot]','coderabbitai[bot]','chatgpt-codex-connector[bot]','github-actions[bot]','claude','claude[bot]','copilot','github-copilot[bot]']);
            const condensed = comments.slice(0, 50).map(c => ({ author: c.user?.login || 'unknown', body: (c.body || '').slice(0, 4000) })).reverse();
            const reviewers = condensed.filter(c => reviewerBots.has(c.author));

            // Expose to next steps
            core.setOutput('pr_title', pr.title);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('file_list', fileList);
            core.setOutput('review_comments', JSON.stringify(reviewers));

      - name: Run Codex to apply minimal safe edits
        id: codex_apply
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          sandbox: workspace-write
          safety-strategy: drop-sudo
          output-file: pr-agent-codex-output.md
          prompt: |
            You are the PR Agent working on PR #${{ needs.gate.outputs.pr_number }} targeting ${{ needs.gate.outputs.base_ref }}.

            Goal: Get THIS PR into a clean, mergeable state with polished but minimal, safe edits. Do NOT open new PRs. Commit fixes directly to the PR branch.

            Context:
            - PR Title: ${{ steps.ctx.outputs.pr_title }}
            - Changed files:
            ${{ steps.ctx.outputs.file_list }}

            Reviewer bot comments (summarize and implement actionable items):
            ${{ steps.ctx.outputs.review_comments }}

            Rules:
            - Make the smallest changes necessary to resolve failures, fix obvious bugs, address security/quality issues, and apply low-risk polish.
            - Do not refactor unrelated code. Avoid churn.
            - Keep public APIs stable. Update tests only if the behavior change is explicitly desired.
            - Add/adjust tests if needed for legit fixes.
            - Write clear commit messages.

            Actions:
            1) Review the repository and PR diff.
            2) Apply minimal edits to address issues raised by tests and reviewers.
            3) Stage your changes (the sandbox supports writing to the workspace).
            4) Stop and return.

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install dependencies (if package.json)
        if: ${{ hashFiles('package.json') != '' }}
        run: |
          npm ci || npm install

      - name: Run tests
        id: test1
        run: |
          if [ -f "package.json" ]; then
            npm test || npm run test || node tests/run-tests.js
          elif [ -f "tests/run-tests.js" ]; then
            node tests/run-tests.js
          else
            echo "No tests found"; exit 0
          fi

      - name: Capture test logs on failure
        if: failure()
        run: |
          echo "Tests failed" > pr-agent-test-failure.txt

      - name: Single repair pass (if tests failed)
        if: ${{ failure() && steps.cfg.outputs.max_fix_rounds != '0' }}
        id: codex_repair
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          sandbox: workspace-write
          safety-strategy: drop-sudo
          output-file: pr-agent-codex-repair.md
          prompt: |
            Tests failed for PR #${{ needs.gate.outputs.pr_number }}.
            You have ONE more chance to repair. Keep edits minimal and focused.
            Use the failure logs to guide the changes:
            Tests failed in the prior step. Please analyze recent edits and common failure points (syntax errors, tests added by reviewers, path/security guards, etc.).

            Apply the smallest changes to make tests pass. Avoid new features. Update or add tests only if the behavior change is intended and obviously correct.

      - name: Re-run tests after repair
        if: steps.codex_repair.outcome == 'success'
        run: |
          if [ -f "package.json" ]; then
            npm test || npm run test || node tests/run-tests.js
          elif [ -f "tests/run-tests.js" ]; then
            node tests/run-tests.js
          else
            echo "No tests found"; exit 0
          fi

      - name: Commit and push changes to PR branch
        if: ${{ success() }}
        run: |
          git config user.name "pr-agent-bot"
          git config user.email "pr-agent-bot@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– PR Agent: minimal fixes and polish"
            git push origin HEAD:${{ needs.gate.outputs.head_ref }}
          fi

      - name: Post summary comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number('${{ needs.gate.outputs.pr_number }}');
            const fs = require('fs');
            const failed = fs.existsSync('pr-agent-test-failure.txt');
            const body = !failed ? `## ðŸ¤– PR Agent

            Changes applied directly to this PR branch and tests passed. You should be able to squash-merge.

            Artifacts attached contain the Codex transcripts and logs.
            ` : `## ðŸ¤– PR Agent

            Attempted minimal fixes, but tests are still failing. See artifacts for details. No new PRs were created.
            `;
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body });

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-agent-${{ needs.gate.outputs.pr_number }}
          path: |
            pr-agent-codex-output.md
            pr-agent-codex-repair.md
            pr-agent-test-failure.txt
          retention-days: 14

      - name: Create status check
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = '${{ needs.gate.outputs.head_sha }}';
            const prNumber = Number('${{ needs.gate.outputs.pr_number }}');
            const fs = require('fs');
            const failed = fs.existsSync('pr-agent-test-failure.txt');
            const conclusion = failed ? 'failure' : 'success';
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            const title = failed ? 'PR Agent: tests failing' : 'PR Agent: ready to merge';
            const summary = failed
              ? 'Attempted minimal fixes; tests are still failing. See workflow run artifacts for details.'
              : 'Minimal fixes and polish applied to this PR branch. Tests passed. You should be able to squash-merge.';

            const text = `Artifacts (transcripts/logs): ${runUrl}\n\nPR: #${prNumber}`;

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'PR Agent',
              head_sha: headSha,
              status: 'completed',
              conclusion,
              details_url: runUrl,
              output: { title, summary, text }
            });
