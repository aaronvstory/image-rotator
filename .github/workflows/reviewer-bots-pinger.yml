name: "Reviewer Bots Pinger"

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  ping:
    if: github.event.pull_request.draft == false && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    concurrency:
      group: bot-pinger-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - name: Wait for reviewer bots window
        run: |
          MINS=${PING_WAIT_MINUTES:-5}
          echo "Waiting ${MINS} minutes for reviewer bots to post..."
          sleep $(( MINS * 60 ))

      - name: Check comments and ping missing bots
        uses: actions/github-script@v7
        with:
          script: |
            const prNum = context.payload.pull_request.number;
            const { data: comments } = await github.rest.issues.listComments({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNum, per_page: 100, sort: 'created', direction: 'desc' });

            const have = new Set(comments.map(c => (c.user && c.user.login || '').toLowerCase()));
            const want = [
              { id: 'sourcery-ai[bot]', trigger: process.env.TRIGGER_SOURCERY || '/sourcery review' },
              { id: 'coderabbitai[bot]', trigger: process.env.TRIGGER_CODERABBIT || '/review' },
              { id: 'github-copilot[bot]', trigger: process.env.TRIGGER_COPILOT || 'copilot: review' },
              { id: 'chatgpt-codex-connector[bot]', trigger: process.env.TRIGGER_CODEX || '/codex review' },
              { id: 'claude', trigger: process.env.TRIGGER_CLAUDE || '/claude review' },
            ];

            const missing = want.filter(w => !have.has(w.id));
            if (!missing.length) {
              console.log('All reviewer bots have already commented.');
              return;
            }

            const triggers = missing.map(m => m.trigger).join('\n');
            const body = `Pinging reviewer bots that have not yet posted:\n\n${triggers}\n\n_(Automated ping after inactivity window)_`;
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNum, body });
